include:
  - '.gitlab/common.yml'
deploy staging:
  stage: deploy staging
  image:
    name: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
    entrypoint:
      - '/usr/bin/env'
  dependencies:
    - build
  id_tokens:
    ID_TOKEN:
      aud: our-identity-provider
  script:
    - *assume_role
    - aws s3 sync build/ s3://stag-$S3_BUCKET_NAME --delete
    - CLOUDFRONT_DOMAIN=$(aws cloudfront list-distributions --query "DistributionList.Items[?Origins.Items[0].DomainName=='stag-$S3_BUCKET_NAME.s3.amazonaws.com'].DomainName" --output text)
  environment:
    name: staging
    url: $CLOUDFRONT_DOMAIN
  only:
    - develop